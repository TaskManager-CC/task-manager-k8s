<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Planner</title>
    <style>
        :root { 
            --bg: #fdfdfd; 
            --card: #fff; 
            --text: #333; 
            --accent: #6c5ce7; 
            --cream-col: #faf8f0;
            --cream-border: #eeeadd;
        }
        body { 
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            background: var(--bg); color: var(--text); margin: 0; padding: 0; 
            height: 100vh; display: flex; flex-direction: column; 
        }

        /* HEADER */
        .header { 
            background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); z-index: 10; height: 50px;
        }
        .week-nav { display: flex; align-items: center; gap: 15px; font-weight: bold; color: #444; }
        .nav-btn { background: #f4f4f4; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; color: #555; font-weight: bold; }
        .nav-btn:hover { background: #e0e0e0; }
        
        /* BOARD LAYOUT - FIT SCREEN */
        .board-container { 
            flex: 1; overflow-x: auto; padding: 15px; display: flex; gap: 10px; 
            background: #fcfcfc; height: calc(100vh - 70px); box-sizing: border-box;
        }
        .column { 
            flex: 1; 
            min-width: 150px; /* Narrower to fit screen */
            background: var(--cream-col); 
            border: 1px solid var(--cream-border);
            border-radius: 12px; 
            display: flex; flex-direction: column; max-height: 100%;
        }
        .column.special { 
            background: #f4f5f7; border-color: #ebecf0; 
            min-width: 140px; 
            flex: 0.8; 
        } 
        
        .col-header { 
            padding: 12px; font-weight: 700; color: #8d8d8d; text-transform: uppercase; font-size: 0.75em; letter-spacing: 1px;
            text-align: center; border-bottom: 1px solid rgba(0,0,0,0.03);
        }
        .col-date { display: block; font-size: 1.2em; color: #2d3436; margin-top: 4px; letter-spacing: 0; }
        
        .task-list { flex: 1; overflow-y: auto; padding: 8px; }

        /* CARD STYLE */
        .card { 
            background: white; 
            padding: 12px; 
            border-radius: 8px; 
            margin-bottom: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.03); 
            cursor: pointer; position: relative;
            border-left: 5px solid #ccc; 
            transition: all 0.2s ease;
            display: flex; flex-direction: column; gap: 4px;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.08); }
        
        .priority-High { border-left-color: #ff7675; }
        .priority-Medium { border-left-color: #fdcb6e; }
        .priority-Low { border-left-color: #00b894; }
        
        .card-title { font-weight: 600; font-size: 0.95em; color: #2d3436; }
        .card-desc { font-size: 0.8em; color: #888; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        /* DEADLINE AT BOTTOM */
        .card-footer { 
            margin-top: 6px; padding-top: 6px; border-top: 1px dashed #eee; 
            font-size: 0.75em; color: #b2bec3; font-weight: 600; 
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .delete-btn { 
            position: absolute; top: 5px; right: 5px; color: #fab1a0; 
            cursor: pointer; font-size: 16px; opacity: 0; transition: 0.2s; 
        }
        .card:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { color: #d63031; }

        /* MODAL */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); 
            display: flex; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(4px);
        }
        .modal { background: white; padding: 30px; border-radius: 20px; width: 400px; box-shadow: 0 25px 50px rgba(0,0,0,0.15); }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e1e1e1; border-radius: 8px; box-sizing: border-box; font-family: inherit; background: #f9f9f9; }
        
        .btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .hidden { display: none !important; }

        /* LOGIN */
        #login-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fdfdfd; display: flex; justify-content: center; align-items: center; z-index: 200; }
        .login-box { background: white; padding: 40px; border-radius: 24px; width: 350px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.05); border: 1px solid #f0f0f0; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:#333; margin-bottom: 5px;">Planner Login</h2>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button class="btn" onclick="handleAuth()">Enter</button>
            <p style="color:#aaa; cursor:pointer; margin-top:20px; font-size: 0.9em;" onclick="toggleAuth()">Create Account</p>
        </div>
    </div>

    <div id="app" class="hidden">
        <div class="header">
            <div class="week-nav">
                <button class="nav-btn" onclick="changeWeek(-1)">‹</button>
                <span id="current-week-label">Jan 2024</span>
                <button class="nav-btn" onclick="changeWeek(1)">›</button>
            </div>
            <div>
                <button class="btn" style="width: auto; padding: 8px 20px; font-size: 0.9em;" onclick="openModal()">+ New Task</button>
                <button class="nav-btn" style="margin-left:10px; width: auto; padding: 8px 12px; border-radius: 10px; font-size: 0.8em;" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="board-container" id="board">
            </div>
    </div>

    <div id="modal" class="modal-overlay hidden">
        <div class="modal">
            <h3 id="modal-title" style="margin-top:0;">New Task</h3>
            <input type="hidden" id="edit-id">
            
            <label style="font-size:0.8em; font-weight:bold; color:#888;">Title</label>
            <input type="text" id="input-title">
            
            <label style="font-size:0.8em; font-weight:bold; color:#888;">Description</label>
            <textarea id="input-desc" rows="3"></textarea>
            
            <label style="font-size:0.8em; font-weight:bold; color:#888;">Deadline (Due Date)</label>
            <input type="date" id="input-due">

            <label style="font-size:0.8em; font-weight:bold; color:#888;">Priority</label>
            <select id="input-priority">
                <option value="Low">Low</option>
                <option value="Medium">Medium</option>
                <option value="High">High</option>
            </select>
            
            <div style="display:flex; gap:10px;">
                <button class="btn" style="background:#f1f2f6; color:#555;" onclick="closeModal()">Cancel</button>
                <button class="btn" onclick="saveTask()">Save</button>
            </div>
        </div>
    </div>

    <script>
        const AUTH_URL = "http://localhost:30001";
        const TASK_URL = "http://localhost:30002";
        let token = localStorage.getItem('token');
        let currentStartDate = new Date(); 
        let allTasks = [];
        let isLogin = true;

        if(token) showApp();

        function getMonday(d) {
            d = new Date(d);
            var day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1); 
            return new Date(d.setDate(diff));
        }
        currentStartDate = getMonday(new Date());

        function toggleAuth() { isLogin = !isLogin; alert("Click 'Enter' to auto-register."); }
        async function handleAuth() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            try { await fetch(`${AUTH_URL}/register`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: u, password: p}) }); } catch(e){}
            const res = await fetch(`${AUTH_URL}/login`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: u, password: p}) });
            const data = await res.json();
            if(data.token) { token = data.token; localStorage.setItem('token', token); showApp(); }
        }
        function logout() { localStorage.removeItem('token'); location.reload(); }
        function showApp() { 
            document.getElementById('login-screen').classList.add('hidden'); 
            document.getElementById('app').classList.remove('hidden'); 
            fetchTasks(); 
        }

        async function fetchTasks() {
            const res = await fetch(`${TASK_URL}/tasks`, { headers: { 'Authorization': `Bearer ${token}` } });
            allTasks = await res.json();
            renderBoard();
        }

        function changeWeek(dir) {
            currentStartDate.setDate(currentStartDate.getDate() + (dir * 7));
            renderBoard();
        }

        function renderBoard() {
            const board = document.getElementById('board');
            board.innerHTML = "";
            const endWeek = new Date(currentStartDate);
            endWeek.setDate(endWeek.getDate() + 6);
            document.getElementById('current-week-label').innerText = 
                `${currentStartDate.toLocaleDateString('en-US', {month:'short', day:'numeric'})} - ${endWeek.toLocaleDateString('en-US', {month:'short', day:'numeric'})}`;

            // NEW Column
            board.appendChild(createColumn("NEW", "new", [], true));

            // Week Columns (Mon - Sun)
            for(let i=0; i<7; i++) {
                let day = new Date(currentStartDate);
                day.setDate(day.getDate() + i);
                const dateStr = day.toISOString().split('T')[0];
                const dayName = day.toLocaleDateString('en-US', {weekday:'short'}); 
                board.appendChild(createColumn(dayName, dateStr, [dateStr], false));
            }

            // DONE Column
            board.appendChild(createColumn("DONE", "done", [], true));
        }

        function createColumn(title, id, dates, isSpecial) {
            const col = document.createElement('div');
            col.className = `column ${isSpecial ? 'special' : ''}`;
            col.ondragover = (e) => e.preventDefault();
            col.ondrop = (e) => handleDrop(e, id);

            const tasksInCol = allTasks.filter(t => {
                if(id === 'new') return t.status === 'new';
                if(id === 'done') return t.status === 'done';
                // For weekly columns, we match scheduled_date, NOT due_date
                return t.status !== 'new' && t.status !== 'done' && t.scheduled_date === dates[0];
            });

            let displayDate = "";
            if(!isSpecial) {
                const d = new Date(dates[0]);
                displayDate = `<span class="col-date">${d.getDate()}</span>`;
            }

            col.innerHTML = `<div class="col-header">${title} ${displayDate}</div><div class="task-list"></div>`;
            const list = col.querySelector('.task-list');
            tasksInCol.forEach(t => list.appendChild(createCard(t)));
            return col;
        }

        function createCard(t) {
            const div = document.createElement('div');
            div.className = `card priority-${t.priority}`;
            div.draggable = true;
            div.ondragstart = (e) => e.dataTransfer.setData("id", t.id);
            div.onclick = () => openModal(t);

            // Display the IMMUTABLE due date
            let dueDisplay = t.due_date ? `Due: ${t.due_date}` : 'No deadline';

            div.innerHTML = `
                <div class="card-title">${t.title}</div>
                ${t.desc ? `<div class="card-desc">${t.desc}</div>` : ''}
                <div class="card-footer">
                    <span>${dueDisplay}</span>
                </div>
                <div class="delete-btn" onclick="deleteTask(event, ${t.id})">✖</div>
            `;
            return div;
        }

        async function handleDrop(e, targetId) {
            e.preventDefault();
            const id = e.dataTransfer.getData("id");
            let updateData = { id: id };

            if(targetId === 'new') { 
                updateData.status = 'new'; 
                updateData.scheduled_date = ''; // Clear schedule
            }
            else if(targetId === 'done') { 
                updateData.status = 'done'; 
            }
            else { 
                // targetId is a date string like '2024-01-20' (The Mon-Sun column)
                updateData.status = 'active'; 
                updateData.scheduled_date = targetId; // Only update schedule, keep due_date
            }

            // Optimistic Update
            const task = allTasks.find(t => t.id == id);
            if(task) { 
                task.status = updateData.status; 
                if(updateData.scheduled_date !== undefined) task.scheduled_date = updateData.scheduled_date; 
                renderBoard(); 
            }

            await fetch(`${TASK_URL}/tasks`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(updateData) });
        }

        function openModal(task = null) {
            const modal = document.getElementById('modal');
            modal.classList.remove('hidden');
            if(task) {
                document.getElementById('modal-title').innerText = "Edit Task";
                document.getElementById('edit-id').value = task.id;
                document.getElementById('input-title').value = task.title;
                document.getElementById('input-desc').value = task.desc || '';
                document.getElementById('input-due').value = task.due_date || ''; 
                document.getElementById('input-priority').value = task.priority;
            } else {
                document.getElementById('modal-title').innerText = "New Task";
                document.getElementById('edit-id').value = "";
                document.getElementById('input-title').value = "";
                document.getElementById('input-desc').value = "";
                document.getElementById('input-due').value = "";
            }
        }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        async function saveTask() {
            const id = document.getElementById('edit-id').value;
            const title = document.getElementById('input-title').value;
            const desc = document.getElementById('input-desc').value;
            const due = document.getElementById('input-due').value;
            const priority = document.getElementById('input-priority').value;
            
            if(!title) return;

            const body = { title, priority, description: desc, due_date: due }; 

            if(id) {
                body.id = id;
                await fetch(`${TASK_URL}/tasks`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(body) });
            } else {
                body.status = 'new';
                await fetch(`${TASK_URL}/tasks`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(body) });
            }
            closeModal();
            fetchTasks();
        }

        async function deleteTask(e, id) {
            e.stopPropagation();
            if(!confirm("Delete?")) return;
            await fetch(`${TASK_URL}/tasks?id=${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
            fetchTasks();
        }
    </script>
</body>
</html>